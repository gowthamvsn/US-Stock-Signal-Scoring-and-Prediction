import pandas as pd
from joblib import load, dump

# ==============================
# LOAD DATA GENERATED BY FILE 1
# ==============================
FLAGS_PATH = "data/flags_with_target.csv"
WEIGHTS_PATH = "data/indicator_weights.csv"
MASTER_PATH = "data/master_ohlcv.csv"

flags_df = pd.read_csv(FLAGS_PATH)
weights_df = pd.read_csv(WEIGHTS_PATH)
df_all = pd.read_csv(MASTER_PATH, parse_dates=["Date"])


# === STAGE 7: Train and Evaluate ML Model ===
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import classification_report
import matplotlib.pyplot as plt
import seaborn as sns

ml_df = flags_df.dropna(subset=['Target','FutureGain_5d','PeakDate']).copy()
#print("columns of ml df ", ml_df.columns)
feature_cols = [col for col in weights_dict if col in ml_df.columns]
#print(" feature cols before training with ML", feature_cols)
X = ml_df[feature_cols]
y = ml_df['Target']
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.15, stratify=y, random_state=42)
#print("y train values ", y_train.value_counts())

model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)
y_pred = model.predict(X_test)

print("ðŸ“Š Classification Report:")
print(classification_report(y_test, y_pred))

stage7time = time.time()
print(" time taken to complete stage 7 ", stage7time - stage6time)


# # === STAGE 8: Visualize Score Distribution vs. Target ===
# sns.boxplot(data=ml_df, x='Target', y='Score')
# plt.title("Score Distribution by Target")
# plt.savefig(rf"D:\tickproject\stock_data\score_vs_target_{TODAY}.png")
# print("âœ… Saved boxplot: score vs. target")


stage8time = time.time()
print(" time taken to complete stage 8 ", stage8time - stage7time)


# === STAGE 9: Save model for future predictions ===
import joblib
model_path = rf"D:\tickproject\stock_data\rf_model_{TODAY_STR}.pkl"
joblib.dump(model, model_path)
print(f"âœ… Saved trained model to {model_path}")


# === STAGE 10: Predict on New Tickers Using Saved Model ===
from joblib import load

MODEL_FILE = model_path  # already saved as rf_model_<TODAY>.pkl
PREDICT_OUTPUT = rf"D:\tickproject\stock_data\predictions_US_{TODAY_STR}.csv"

print("ðŸ”® Predicting on new data...")

# Load model
predict_model = load(MODEL_FILE)

# Filter for post-prediction data
df_future_predict = df_all[(df_all['Date'] >= pd.to_datetime(PREDICT_DATE_START)) & (df_all['Date'] <= pd.to_datetime(PREDICT_DATE_END))].copy()

df_future_indicators = pd.concat([compute_indicators(group) for _, group in df_future_predict.groupby('Ticker')])

# Generate flags as usual
prediction_flags = []
for ticker, group in df_future_indicators.groupby('Ticker'):
    group = group.copy()
    # if group.shape[0] < 5:
    #     continue
    group = compute_indicators(group)

    latest = group.iloc[-1]
    if not latest.empty:
        result = {
            'Ticker': ticker,
            'RSI_under_30': int(latest['RSI'] < 30),
            'MACD_positive': int(latest['MACD_diff'] > 0),
            'Close_above_EMA50': int(latest['Close'] > latest['EMA50']),
            'High_DollarVolume': int(latest['DollarVolume'] > group['DollarVolume'].rolling(20).mean().iloc[-1]),
            'EPS_positive': int(pd.notna(latest['EPS']) and latest['EPS'] > 0),
            'High_GK_Volatility': int(latest['GK_Volatility'] > group['GK_Volatility'].median()),
            'ATR_above_avg': int(latest['ATR'] > group['ATR'].rolling(14).mean().iloc[-1]),
            'Log_Close_above_BB_Lower': int(latest['Log_Close'] > latest['Log_BB_Lower']),
            'Stoch_K_crossover': int(group['Stoch_K'].iloc[-2] < group['Stoch_D'].iloc[-2] and latest['Stoch_K'] > latest['Stoch_D'] and latest['Stoch_K'] < 20),
            'ADX_above_20': int(latest['ADX'] > 20),  # Strong trend
            'ROC_above_2': int(latest['ROC'] > 2),    # Price gain acceleration
            'CCI_extreme': int(abs(latest['CCI']) > 100),  # Overbought or oversold
            'OBV_rising': int(latest['OBV'] > group['OBV'].rolling(5).mean().iloc[-1]),
            'BB_width_expansion': int(latest['BB_Width'] > group['BB_Width'].rolling(20).mean().iloc[-1])
        
        }
        #future_flags.append(result)
        prediction_flags.append(result)

future_flags_df  = pd.DataFrame(prediction_flags)
model = load(model_path)
predict_feature_cols = [
'RSI_under_30', 'MACD_positive', 'Close_above_EMA50',
'High_DollarVolume',  'EPS_positive','High_GK_Volatility',
'ATR_above_avg', 'Log_Close_above_BB_Lower', 'Stoch_K_crossover', 'ADX_above_20',
'ROC_above_2',
'CCI_extreme',
'OBV_rising',
'BB_width_expansion'
]

future_flags_df ['Predicted_Prob'] = model.predict_proba(future_flags_df [predict_feature_cols])[:, 1]
#future_flags_df ['Predicted_Prob'] = model.predict_proba(future_flags_df [predict_feature_cols])

print("Proba columns:", future_flags_df.columns)
print("Proba shape:", future_flags_df.shape)


future_flags_df.sort_values('Predicted_Prob', ascending=False).to_csv(rf"D:\tickproject\stock_data\predictions_US_{TODAY_STR}.csv", index=False)
print("âœ… Saved predictions on new data")
